<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SEEGVIS</title>
    <link rel="icon" href="/static/data/eeg3.jpg">
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/echarts.min.js"></script>
    <script src="/static/js/echarts-gl.min.js"></script>

    <script src="/static/js/visChart.js"></script>

    <script src="/static/js/d3.v4.js"></script>
    <script src="/static/js/d3-scale-chromatic.v1.min.js"></script>
    <style type="text/css">
        input{
            display:inline-block!important;
        }
        .tab1 > tbody > tr:nth-child(2n-1) > td,
        .tab1 > tbody > tr:nth-child(2n-1) > th {
            {#background-color: #afd9ee;#}
             background-color: rgba(0,255,255,0.1);
         }

        .tab1 > tbody > tr:nth-child(2n) > td,
        .tab1 > tbody > tr:nth-child(2n) > th {
            {#background-color: #8EB2D2;#}
            background-color: rgba(120,100,130,0.1);
         }
        <!--
        .axis path,
        .axis line{
            fill:none;
            stroke:black;
            shape-rendering:crispEdges;
        }
        -->
        .axis_line text{
            font-family: sans-serif;
            font-size: 12px;
        }
        .axis_violin text {
            font-family: sans-serif;
            font-size: 15px;
        }
        div.tooltip {
            position: absolute;
            text-align: center;
            width: 60px;
            height: 22px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        div.tooltip2 {
            position: absolute;
            text-align: center;
            width: 96px;
            height: 68px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        #line_tab{
            display: inline-block;
            width: 400px;
            text-align: center;
        }
        #line_tab caption{
            font-size: 26px;
            font-weight: bold;
            color: orangered;
            width: 400px;
            text-align: center;
        }
    </style>

</head>
<body>
<div class="panel-group" id="accordion">
    <div class="panel panel-default">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
            <h4 class="panel-title">
                <label>基本信息</label>
                <span class="badge" id="systemGuide" style="float: right;font-size:18px; margin-right: 50px;cursor: pointer;" title="查看使用说明">系统指南</span>
            </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in">
            <div class="panel-body">
                <form method="post" action="/" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% if not fc_info %}
                        请上传mat格式文件：<input type="file" accept=".mat" name="up_file" class="file_mat"/>
                        <input type="submit" value="提交" class="submit_mat"/><br>
                    {% else %}
                        更改数据文件：<input type="file" accept=".mat" name="up_file" class="file_mat"/>
                        <input type="submit" value="更改" class="submit_mat"/><br>
                    {% endif %}
                </form>
                <table align="center" class="table tab1 table-bordered" style="text-align: center;max-width: 90%">
                    {% if fc_info %}
                    <caption style="font-size: 26px;font-weight: bold;text-align: center;margin-bottom: 10px;">
                        当前上传的数据文件为：<font color="red">{{ file_name }}</font>
                    </caption>
                    {% endif %}
                    <tbody>
                    {% for key,value in fc_info.items %}
                        <tr class="active">
                            <td>{{ key }}</td>
                            <td>{{ value }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="panel panel-success">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
            <h4 class="panel-title">
                <label>空间坐标</label>
            </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse">
            <div class="panel-body" id="electrodes">
                请上传对应电极点的空间坐标：<input type="file" accept=".txt,.csv" id="coordinate_file" onchange="showCoordinate(this.files,{{ fc_info.electrode_names }})"/>
            </div>
        </div>
    </div>
    <div class="panel panel-info">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
            <h4 class="panel-title">
                <label>折线图</label>
            </h4>
        </div>
        <div id="collapseThree" class="panel-collapse collapse">
            <div class="panel-body">
                <table>
                    <tbody>
                    <tr>
                        <td style="padding:15px 10px">
                            <div class="input-group">
                                <span class="input-group-addon">信号1（S1）：</span>
                                <input class="form-control" type="text" id="s1">
                            </div>
                        </td>
                        <td style="padding:15px 10px">
                            <div class="input-group">
                                <span class="input-group-addon">信号2（S2）：</span>
                                <input class="form-control" type="text" id="s2">
                            </div>
                        </td>
                        <td>
                            <label class="btn btn-success" onclick="getH2({{ fc_info }})">提交</label>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <!-- Create a div where the graph will take place -->
                <div id="my_dataviz"></div>
            </div>
        </div>
    </div>
    <div class="panel panel-warning">
        <div class="panel-heading"  data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
            <h4 class="panel-title">
                <label>小提琴图</label>
            </h4>
        </div>
        <div id="collapseFour" class="panel-collapse collapse">
            <div class="panel-body">
                <div id="analyse">
                    <table>
                        <tbody>
                        <tr>
                            <td style="margin-left: 10px">
                                <label class="btn btn-primary" onclick="assignZone()">参考空间坐标</label>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">EZ: </span>
                                    <input class="form-control" type="text" id="EZ">
                                </div>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">PZ: </span>
                                    <input class="form-control" type="text" id="PZ">
                                </div>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">NIZ: </span>
                                    <input class="form-control" type="text" id="NIZ">
                                </div>
                            </td>
                            <td>
                                <label class="btn btn-success" onclick="fcAnalyse()">FC分析</label>
                            </td>
                            <td >
                                <a id="fc_result" style="margin-left: 15px;display: none;" href="/static/data/fc_result.csv">点击下载FC分析结果</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <!-- Create a div where the graph will take place -->
                    <div id="violinBwt">
                        <div id="violinLeft" style="width:1000px;float:left; text-align: center;margin-left: 10px;"></div>
                        <div id="violinRight" style="width:300px;float:left; text-align: center;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-danger">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseFive">
            <h4 class="panel-title">
                <label>OUT,OUT/IN,OUT-IN分析</label>
            </h4>
        </div>
        <div id="collapseFive" class="panel-collapse collapse">
            {% if links %}
                OUT LINKS:<br>
                {{ links.0 }} <br>
                IN LINKS:<br>
                {{ links.1 }}
                <div>
                    <a id="out_result" href="/static/data/out_result.xls">点击下载OUT分析结果</a>
                </div>
            {% endif %}
            <div class="panel-body">
                <div style="text-align: center">
                    <button class="btn btn-default" onclick="out_in_analyse(this,'OUT',{{ fc_info.electrode_names }})">OUT</button>
                    <button class="btn btn-default" onclick="out_in_analyse(this,'OUT/IN',{{ fc_info.electrode_names }})">OUT / IN</button>
                    <button class="btn btn-default" onclick="out_in_analyse(this,'OUT-IN',{{ fc_info.electrode_names }})">OUT - IN</button>
                    <button class="btn btn-default" onclick="out_in_analyse(this,'IN',{{ fc_info.electrode_names }})">IN</button>
                </div>
                <div>
                    <div id="out_in_river" style="height: 500px; width: 58%; float: left"></div>
                    <div id="out_in_heat" style="height: 500px; width: 42%; float: left"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    var one_elect = new Set(); //电极点名字
    var one_elect_co = {};
    var init = false;
    var msg={{ msg|safe }};
    if(msg){
        alert(msg);
    }
    var ez_p=[];
    var pz_p=[];
    var niz_p=[];
    var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

    var div2 = d3.select("body").append("div")
    .attr("class", "tooltip2")  //area
    .style("opacity", 0);

    $(".submit_mat").click(function(e){
        //alert($(".file_mat").val());
        if (!$(".file_mat").val()){
            alert("您还未选择.mat数据文件!");
            e.preventDefault();
        }
    });
    //阻止默认行为，stopPropagation(); -- 阻止元素冒泡事件
    $("#coordinate_file").click(function(e){
        /* js与Django交互的条件：
        1、views.py中返回的函数中的值要用 json.dumps()处理
        2、在网页上要加一个 safe 过滤器
         */
        init = {{ file_name|safe }};
        if (!init){
            alert("请先上传.mat数据文件!");
            e.preventDefault();
        }
    });
    $("#systemGuide").click(function(e){
        e.stopPropagation();
        $(window).attr('location', '{% url 'guide' %}');
    });
    function getH2(fc_info) {
        if(!fc_info){
            alert("请先上传.mat数据文件!");
            return;
        }
        var s1 = parseInt($("#s1").val());
        var s2 = parseInt($("#s2").val());
        if (isNaN(s1)||isNaN(s2)||s1<0||s2<0){
            //alert(s1+"\n"+s2);
            alert("请正确输入两电极信号（格式需为非负整数）！");
            return;
        }
        var elen = fc_info["electrode_names"].length;
        if(s1>=elen || s2>=elen){
            alert("输入信号应小于"+elen+" !");
            return;
        }
        $.post('{% url 'getH2' %}',{"s1":s1,"s2":s2},function(result, statue){
                if(result["result"] === true){
                    //h2_max, lag_max, nw_direction, (sp - sn) / (sp + sn)
                    var s1_s2 = result["s1_s2"];
                    var signal = [fc_info["electrode_names"][s1],fc_info["electrode_names"][s2]];
                    var lens = fc_info["section_iterations"];
                    var times = d3.range(fc_info["start"],fc_info["start"]+lens);
                    var data = [];
                    for(i=0;i<lens;i++){
                        data.push({"time":times[i],"h2":s1_s2[0][i]})
                    }
                    linechart(data,signal,lens,s1_s2[2],s1_s2[3],twoElectCO(signal,one_elect_co));
                }else {
                    alert("Failed!\n message:"+result["msg"])
                }
        });
    }
    function fcAnalyse(){
        init = {{ file_name|safe }};
        if (!init){
            alert("请先上传.mat数据文件!");
            return;
        }
        var ez = $("#EZ").val();
        var pz = $("#PZ").val();
        var niz = $("#NIZ").val();
        if (!(ez || pz || niz)){
            alert("您还未输入电极！(EZ、PZ、NIZ不一定要全部输入）\n请用数字表示，格式应如：0-2,4");
            return;
        }
        var fc_result = document.getElementById("fc_result");
        fc_result.style.display = "none";
        // alert(ez+"\n"+pz+"\n"+niz)
        $.post('{% url 'fcAnalyse' %}',{"ez":ez,"pz":pz,"niz":niz},function(result, statue){
                if(result["result"] === true){
                    //h2_max, lag_max, nw_direction, (sp - sn) / (sp + sn)
                    var zones = result["zones"];
                    //alert(zones);
                    fc_result.style.display = "inline";
                    violinBwt();
                }else {
                    alert(result["msg"])
                }
        });
    }
    function showCoordinate(files,electrode_names) {
        //console.log(files);
        if (files[0]) {
            var reader = new FileReader();
            reader.readAsText(files[0]);
            /*
            reader.onload = function () {
                globaldata = this.result;
            }
            reader.onloadend = function (evt) {
                if(evt.target.readyState == FileReader.DONE){
                    globaldata.push(csv2array(reader.result.toString()));
                }
            };
            */
            reader.onload = function (f) {
                //var result = document.getElementById("result");
                //显示文件
                one_elect.clear();
                for(var i=0;i<electrode_names.length;i++){
                    var two_e = electrode_names[i].split("-");
                    one_elect.add(two_e[0]);
                    one_elect.add(two_e[1]);
                }
                var co_data={"ez":[],"pz":[],"niz":[]};
                var relArr = this.result.split("\r\n");
                //var regp = new RegExp(".*,\".*,.*\"$");
                var regp = /[^\w\s,.-]/;
                if (!$.isEmptyObject(relArr) && relArr.length > 1) {
                    for (var cokey in one_elect_co){
                        //delete one_elect_co.cokey; 清空字典，只能使用下面的方法
                        delete one_elect_co[cokey];
                    }
                    var title_key = relArr[0].split(",");
                    for (var key = 1, len = relArr.length; key < len; key++) {
                        var values = relArr[key];
                        if (regp.test(values)) {
                            alert("文件内容中含有非法符号，请修改后再上传！含有非法符号的内容为：" + values);
                            return;
                        }
                        if (!$.isEmptyObject(values)) {
                            var obj = [];
                            var objArr = values.split(",");
                            for (var j=1;j<objArr.length;j++){
                                obj.push(objArr[j].replace(/\s/ig,'')); //过滤空白字符
                            }
                            if (objArr[0] === "ez"){
                                co_data.ez.push(obj);
                            } else if (objArr[0] === "pz"){
                                co_data.pz.push(obj);
                            }else if (objArr[0] === "niz"){
                                co_data.niz.push(obj);
                            }

                            if (isInSet(obj[3],one_elect)){
                                one_elect_co[obj[3]] = strArr2floatArr(obj.slice(0,-1));
                            }
                        }
                    }
                }
                $("#codination").remove();
                var newM = $("<div id='codination' style='width: 85%;height:500px;' align='center'></div>");
                newM.appendTo($("#electrodes"));
                scatter3D(co_data,'codination');
                /*
                var s1 = $("#s1").val();
                var s2 = $("#s2").val();
                if (typeof(s1)==="number"&&typeof(s2)==="number"){
                }
                */
                ez_p.length = 0;
                pz_p.length = 0;
                niz_p.length = 0;
                //console.log(co_data)
                for(var ii=0;ii<electrode_names.length;ii++){
                    var one_e = electrode_names[ii].split("-")[0];
                    //console.log(one_e)
                    var flag = true;
                    for (var jj=0;jj<co_data["ez"].length;jj++){
                        if (co_data["ez"][jj][3].includes(one_e)){
                            ez_p.push(ii);
                            flag = false;
                            break;
                        }
                    }
                    if (flag){
                        for (var jj=0;jj<co_data["pz"].length;jj++){
                            if (co_data["pz"][jj][3].includes(one_e)){
                                pz_p.push(ii);
                                flag = false;
                                break;
                            }
                        }
                    }
                    if (flag){
                        for (var jj=0;jj<co_data["niz"].length;jj++){
                            if (co_data["niz"][jj][3].includes(one_e)){
                                niz_p.push(ii);
                                //flag = false;
                                break;
                            }
                        }
                    }
                }
                //console.log(ez_p,pz_p,niz_p)
            };
        }
    }
    function assignZone() {
        if (one_elect.size === 0){
            alert("您未上传空间坐标文件,\n无法默认取值！");
            return;
        }
        if (ez_p.length+pz_p.length+niz_p.length === 0){
            alert("您上传的空间坐标文件与基本信息中的电极不符,\n无法默认取值！");
            return;
        }
        var ez_s="";
        var pz_s="";
        var niz_s="";
        for (i of ez_p){
            ez_s += ", "+i;
        }
        for (i of pz_p){
            pz_s += ", "+i;
        }
        for (i of niz_p){
            niz_s += ", "+i;
        }
        if (ez_s.length){
            $("#EZ").val(ez_s.slice(1))
        }
        if (pz_s.length){
            $("#PZ").val(pz_s.slice(1))
        }
        if (niz_s.length){
            $("#NIZ").val(niz_s.slice(1))
        }
    }
    function isInSet(item,set) {
        for (var si of set){
            if (item === si){
                return true;
            }
        }
        return false;
    }
    function strArr2floatArr(strArr) {
        var floatArr = [];
        for (var sai of strArr){
            floatArr.push(parseFloat(sai));
        }
        return floatArr;
    }
    function twoElectCO(signal,co) {
        /*
         返回电极对的中心坐标
         signal的格式例如： ['C4-C5', 'C6-C7']
          */
        var s1 = signal[0].split('-');
        var s2 = signal[1].split('-');
        return [centerPoint(co[s1[0]],co[s1[1]]),centerPoint(co[s2[0]],co[s2[1]])]
    }
    function centerPoint(co1,co2) {
        if (!(co1&&co2)){
            return null;
        }
        return [(co1[0]+co2[0])/2,(co1[1]+co2[1])/2,(co1[2]+co2[2])/2]
    }

    function out_in_analyse(e,type,electrode_names) {
        // var channel_select = $("#channel_select").val();
        let step = {{ fc_info.step }};
        $(e).siblings().removeClass().addClass("btn btn-default");
        $(e).removeClass().addClass("btn btn-success");
        let links = {'out':{{ links.0 }},'in':{{ links.1 }}};
        let start = {{ fc_info.start }};
        // console.log(electrode_names);
        let stream_data=[];
        let heap_data=[];
        let time = [];
        let len_t = links.out.length;
        let len_e = links.out[0].length;
        let min = 0;
        let max = 0;
        let value = 0;
        for(let i = 0; i < len_t; i++){  // i 是时间
            let t = start + i * step;
            time.push(t);
            for (let j = 0; j < len_e; j++){  // j 是 电极
                if(type === 'OUT'){
                    value = links.out[i][j];
                }
                else if(type === 'IN'){
                    value = links.in[i][j];
                }
                else if(type === 'OUT/IN'){
                    value = parseFloat(((links.out[i][j] + 1) / (links.in[i][j] + 1)).toFixed(4));
                }
                else if(type === 'OUT-IN'){
                    value = links.out[i][j] - links.in[i][j];
                }
                stream_data.push([t, value, electrode_names[j]]);
                heap_data.push([i, len_e - j - 1, value]);
                if (value > max) {
                    max = value;
                } else if (value < min) {
                    min = value;
                }
            }
        }
        // console.log(min, max);
        if(type === 'OUT-IN'){
            for (let i =0; i < stream_data.length; i++){
                stream_data[i][1] -= min;
            }
        }
        // console.log(stream_data);
        /*
        var data = [['18',10,'DQ'],['19',15,'DQ'],['20',35,'DQ'],
            ['21',38,'DQ'],['22',22,'DQ'],['23',16,'DQ'],
            ['24',7,'DQ'],['25',2,'DQ'],['26',17,'DQ'],
            ['27',33,'DQ'],['28',40,'DQ'],['29',32,'DQ'],
            ['30',26,'DQ'],['31',35,'DQ'],['32',40,'DQ'],
            ['33',32,'DQ'],['34',26,'DQ'],['35',22,'DQ'],
            ['36',16,'DQ'],['37',22,'DQ'],['38',10,'DQ'],
            ['18',35,'TY'],['19',36,'TY'],['20',37,'TY'],
            ['21',22,'TY'],['22',24,'TY'],['23',26,'TY'],
            ['24',34,'TY'],['25',21,'TY'],['26',18,'TY'],
            ['27',45,'TY'],['28',32,'TY'],['29',35,'TY'],
            ['30',30,'TY'],['31',28,'TY'],['32',27,'TY'],
            ['33',26,'TY'],['34',15,'TY'],['35',30,'TY'],
            ['36',35,'TY'],['37',42,'TY'],['38',42,'TY'],
            ['18',21,'SS'],['19',25,'SS'],['20',27,'SS'],
            ['21',23,'SS'],['22',24,'SS'],['23',21,'SS'],
            ['24',35,'SS'],['25',39,'SS'],['26',40,'SS'],
            ['27',36,'SS'],['28',33,'SS'],['29',43,'SS'],
            ['30',40,'SS'],['31',34,'SS'],['32',28,'SS'],
            ['33',26,'SS'],['34',37,'SS'],['35',41,'SS'],
            ['36',46,'SS'],['37',47,'SS'],['38',41,'SS'],
            ['18',10,'QG'],['19',15,'QG'],['20',35,'QG'],
            ['21',38,'QG'],['22',22,'QG'],['23',16,'QG'],
            ['24',7,'QG'],['25',2,'QG'],['26',17,'QG'],
            ['27',33,'QG'],['28',40,'QG'],['29',32,'QG'],
            ['30',26,'QG'],['31',35,'QG'],['32',40,'QG'],
            ['33',32,'QG'],['34',26,'QG'],['35',22,'QG'],
            ['36',16,'QG'],['37',22,'QG'],['38',10,'QG'],
            ['18',10,'SY'],['19',15,'SY'],['20',35,'SY'],
            ['21',38,'SY'],['22',22,'SY'],['23',16,'SY'],
            ['24',7,'SY'],['25',2,'SY'],['26',17,'SY'],
            ['27',33,'SY'],['28',40,'SY'],['29',32,'SY'],
            ['30',26,'SY'],['31',35,'SY'],['32',4,'SY'],
            ['33',32,'SY'],['34',26,'SY'],['35',22,'SY'],
            ['36',16,'SY'],['37',22,'SY'],['38',10,'SY'],
            ['18',10,'DD'],['19',15,'DD'],['20',35,'DD'],
            ['21',38,'DD'],['22',22,'DD'],['23',16,'DD'],
            ['24',7,'DD'],['25',2,'DD'],['26',17,'DD'],
            ['27',33,'DD'],['28',4,'DD'],['29',32,'DD'],
            ['30',26,'DD'],['31',35,'DD'],['32',40,'DD'],
            ['33',32,'DD'],['34',26,'DD'],['35',22,'DD'],
            ['36',16,'DD'],['37',22,'DD'],['38',10,'DD']];
        */
        stream_out_in(stream_data,type,electrode_names,[start, start + len_t - 1]);
        heat_out_in(heap_data,min,max,electrode_names.reverse(),time,type);
    }
</script>
</html>