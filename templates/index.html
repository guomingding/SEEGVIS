<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SEEGVIS</title>
    <link rel="icon" href="/static/data/eeg3.jpg">
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/echarts.min.js"></script>
    <script src="/static/js/echarts-gl.min.js"></script>

    <link href="/static/css/bootstrap-slider.css" rel="stylesheet">
    <script type="text/javascript" src="/static/js/bootstrap-slider.js"></script>

    <script src="/static/js/visChart.js"></script>

    <script src="/static/js/d3.v4.js"></script>
    <script src="/static/js/d3-scale-chromatic.v1.min.js"></script>
    <style type="text/css">
        table.table-bordered th {
            text-align: center;
        }
        #time_marks tr td{
            vertical-align: middle;
        }
        #time_marks tr td button{
            margin-left: 10px;
            margin-right: 10px;
        }
        #collapseOne .slider.slider-horizontal {
            max-width: 800px;
            min-width: 200px;
            width: 41%;
            height: 20px;
        }
        .slider-selection {
            background: red;
        }

        input.button{
            display: inline-block;
        }
        .tab1 > tbody > tr:nth-child(2n-1) > td,
        .tab1 > tbody > tr:nth-child(2n-1) > th {
            {#background-color: #afd9ee;#}
             background-color: rgba(0,255,255,0.1);
         }

        .tab1 > tbody > tr:nth-child(2n) > td,
        .tab1 > tbody > tr:nth-child(2n) > th {
            {#background-color: #8EB2D2;#}
            background-color: rgba(120,100,130,0.1);
         }
        <!--
        .axis path,
        .axis line{
            fill:none;
            stroke:black;
            shape-rendering:crispEdges;
        }
        -->
        .axis_line text{
            font-family: sans-serif;
            font-size: 12px;
        }
        .axis_violin text {
            font-family: sans-serif;
            font-size: 15px;
        }
        div.tooltip1 {
            position: absolute;
            text-align: center;
            width: 90px;
            height: 22px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        div.tooltip2 {
            position: absolute;
            text-align: center;
            width: 96px;
            height: 68px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        #line_tab{
            display: inline-block;
            width: 400px;
            text-align: center;
        }
        #line_tab caption{
            font-size: 26px;
            font-weight: bold;
            color: orangered;
            width: 400px;
            text-align: center;
        }
    </style>

</head>
<body>
<div class="panel-group" id="accordion">
    <div class="panel panel-default">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
            <h4 class="panel-title">
                <label>基本信息</label>
                <span class="badge" id="systemGuide" style="float: right;font-size:18px; margin-right: 50px;cursor: pointer;" title="查看使用说明">系统指南</span>
            </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in">
            <div class="panel-body">
                <form method="post" action="/" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% if not fc_info %}
                        请上传mat格式文件：<input type="file" accept=".mat" name="up_file" class="file_mat button"/>
                        <input type="submit" value="提交" class="submit_mat button"/><br>
                    {% else %}
                        更改数据文件：<input type="file" accept=".mat" name="up_file" class="file_mat button"/>
                        <input type="submit" value="更改" class="submit_mat button"/><br>
                    {% endif %}
                </form>
                {% if fc_info %}
                <table align="center" class="table tab1 table-bordered" style="text-align: center;max-width: 90%">
                    <caption style="font-size: 26px;font-weight: bold;text-align: center;margin-bottom: 10px;">
                        当前上传的数据文件为：<font color="red">{{ file_name }}</font>
                    </caption>
                    <tbody>
                    {% for key,value in fc_info.items %}
                        <tr class="active">
                            <td>{{ key }}</td>
                            <td>{{ value }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <div style="margin-top:40px; text-align: center;">
                &nbsp;&nbsp;<b>筛选时间：{{ fc_info.start }}&nbsp;&nbsp;&nbsp;&nbsp;</b><input id="time_slider" type="text"/><b>&nbsp;&nbsp;&nbsp;&nbsp;{{ fc_info.end }}</b>
                    <div style="display:inline-block; width:200px; margin-left: 10px; vertical-align: bottom;">
                        <div class="input-group">
                            <span class="input-group-addon">h2阈值</span>
                            <input id="h2_threshold" type="text" class="form-control" value="0" maxlength="12" onkeyup="value=value.replace(/[^.\d]/g,'')">
                        </div>
                    </div>
                &nbsp;&nbsp;<button class="btn btn-success" onclick="select_time()">确认</button>&nbsp;
                    <div id="select_confirm" style="display:inline-block;font-size: larger; width: 105px; text-align: left;"></div>
                </div>
                <div style="margin-top: 20px; text-align: center">
                    <div>
                        <label>
                            <span class="btn btn-primary"> 
                                读取标记文件<input type="file" style="display: none;" multiple onchange="readFromCsv(this,readToArray)">
                            </span>
                        </label>
                        <button class="btn btn-primary" onclick="saveMarks()">保存时间标记</button>
                        <button class="btn btn-primary" data-toggle="modal" data-target="#myModal"
                                onclick=$("#operate_type").text("新增")>新增时间标记</button>
                        <button class="btn btn-primary" onclick=$("#time_marks").empty()>清空所有标记</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <table class="table table-bordered" align="center" style="width: 72%">
                            <thead>
                                <tr>
                                    <th width="145px;">标记名</th>
                                    <th width="135px;">起始时间</th>
                                    <th width="135px;">终止时间</th>
                                    <th style="min-width: 160px;">描述</th>
                                    <th width="250px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="time_marks">
                            </tbody>
                        </table>
                    </div>
                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="cancel()">
                                        &times;
                                    </button>
                                    <h4 class="modal-title" id="myModalLabel">
                                        <span id="operate_type"></span>时间标记
                                    </h4>
                                </div>
                                <div class="modal-body">
                                    <div style="display: inline-block; width: 34%;">
                                        <div class="input-group">
                                            <span class="input-group-addon">标记名</span>
                                            <input id="add_name" type="text" class="form-control">
                                        </div>
                                    </div>
                                    <div style="display: inline-block; width: 32%;">
                                        <div class="input-group">
                                            <span class="input-group-addon">起始时间</span>
                                            <input id="add_start" type="text" class="form-control" onkeyup="value=value.replace(/[^.\d]/g,'')">
                                        </div>
                                    </div>
                                    <div style="display: inline-block; width: 32%;">
                                        <div class="input-group">
                                            <span class="input-group-addon">终止时间</span>
                                            <input id="add_end" type="text" class="form-control" onkeyup="value=value.replace(/[^.\d]/g,'')">
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-addon">描述</span>
                                        <input id="add_desc" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="cancel()">取消</button>
                                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="operateMarks()">
                                        确定
                                    </button>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal -->
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="panel panel-success">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
            <h4 class="panel-title">
                <label>空间坐标</label>
            </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse">
            <div class="panel-body" id="electrodes">
                请上传对应电极点的空间坐标：<input type="file" accept=".txt,.csv" id="coordinate_file" class="button"
                                     onchange="showCoordinate(this.files)"/>
            </div>
        </div>
    </div>
    <div class="panel panel-info">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
            <h4 class="panel-title">
                <label>折线图</label>
            </h4>
        </div>
        <div id="collapseThree" class="panel-collapse collapse">
            <div class="panel-body">
                <table>
                    <tbody>
                    <tr>
                        <td style="padding:15px 10px">
                            <div class="input-group">
                                <span class="input-group-addon">信号1（S1）：</span>
                                <input class="form-control" type="text" id="s1">
                            </div>
                        </td>
                        <td style="padding:15px 10px">
                            <div class="input-group">
                                <span class="input-group-addon">信号2（S2）：</span>
                                <input class="form-control" type="text" id="s2">
                            </div>
                        </td>
                        <td>
                            <label class="btn btn-success" onclick="getH2()">提交</label>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <!-- Create a div where the graph will take place -->
                <div id="my_dataviz"></div>
            </div>
        </div>
    </div>
    <div class="panel panel-warning">
        <div class="panel-heading"  data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
            <h4 class="panel-title">
                <label>小提琴图</label>
            </h4>
        </div>
        <div id="collapseFour" class="panel-collapse collapse">
            <div class="panel-body">
                <div id="analyse">
                    <table>
                        <tbody>
                        <tr>
                            <td style="margin-left: 10px">
                                <label class="btn btn-primary" onclick="assignZone()">参考空间坐标</label>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">EZ: </span>
                                    <input class="form-control" type="text" id="EZ">
                                </div>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">PZ: </span>
                                    <input class="form-control" type="text" id="PZ">
                                </div>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">NIZ: </span>
                                    <input class="form-control" type="text" id="NIZ">
                                </div>
                            </td>
                            <td>
                                <label class="btn btn-success" onclick="fcAnalyse()">FC分析</label>
                            </td>
                            <td >
                                <a id="fc_result" style="margin-left: 15px;display: none;" href="/static/data/fc_result.csv">点击下载FC分析结果</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <!-- Create a div where the graph will take place -->
                    <div id="violinBwt">
                        <div id="violinLeft" style="width:1000px;float:left; text-align: center;margin-left: 10px;"></div>
                        <div id="violinRight" style="width:300px;float:left; text-align: center;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-danger">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseFive">
            <h4 class="panel-title">
                <label>OUT&nbsp;分析</label>
            </h4>
        </div>
        <div id="collapseFive" class="panel-collapse collapse">
            <div id="out_result" style="margin-left: 12px; display: none;">
                OUT LINKS:<br>
                <span id="out_links"></span><br>
                IN LINKS:<br>
                <span id="in_links"></span><br>
                <a href="/static/data/out_result.xls">点击下载OUT分析结果</a>
            </div>
            <div class="panel-body">
                <table align="center">
                    <td style="width: 168px;">
                        <b style="font-size: larger;">当前h2阈值为：<span id="h2_threshold_value" style="color: red">0</span></b>
                    </td>
                    <td style="padding-right: 20px;">
                        <input id="h2_threshold2" class="form-control" type="text"/>
                    </td>
                    <td>
                        <button class="btn btn-default" onclick="outAnalyse(this,'OUT')">OUT</button>
                        <button class="btn btn-default" onclick="outAnalyse(this,'OUT/IN')">OUT / IN</button>
                        <button class="btn btn-default" onclick="outAnalyse(this,'OUT-IN')">OUT - IN</button>
                        <button class="btn btn-default" onclick="outAnalyse(this,'IN')">IN</button>
                    </td>
                </table>
                <div id="out_chart" style="display: none; margin-top: 15px;">
                    <div id="out_in_river" style="height: 500px; width: 58%; float: left"></div>
                    <div id="out_in_heat" style="height: 500px; width: 42%; float: left"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    var fc_info = {{ fc_info | default:"null"|safe }}; // 注意： 冒号后面不能有空格！ 引号中可以是对象，如 :"{xk:12}"
    var init = {{ file_name|default:"null"|safe }};
    var msg = {{ msg|default:"null"|safe }};
    if(msg){
        alert(msg);
    }
    var one_elect = new Set(); //电极点名字
    var one_elect_co = {};
    var ez_p=[];
    var pz_p=[];
    var niz_p=[];

    var div = d3.select("body").append("div")
    .attr("class", "tooltip1")
    .style("opacity", 0);

    var div2 = d3.select("body").append("div")
    .attr("class", "tooltip2")  //area
    .style("opacity", 0);

    var h2_threshold = 0;
    var h2_threshold_slider = new Slider("#h2_threshold2", {
        min: 0,
        max: 1,
        step: 0.001,
        value: 0
    });
    h2_threshold_slider.on("change", function (val) {  // 不能用slide，因为slide 是指拖动，不是改变
        $("#h2_threshold_value").text(val.newValue);
        $("#h2_threshold").val(val.newValue);
        h2_threshold = val.newValue;
    });

    var time_slider = null;
    if (init){
        time_slider = new Slider('#time_slider', {
            min: fc_info.start,
            max: fc_info.end,
            step: fc_info.step,
            value: [fc_info.start, fc_info.end],
            // tooltip: 'always'
        });
        /*
        slider.on("slideStart", function(o){
            console.log("OO",o);
            //console.log("NN",n);
        });
        */
    }

    $(".submit_mat").click(function(e){
        //alert($(".file_mat").val());
        if (!$(".file_mat").val()){
            alert("您还未选择.mat数据文件!");
            e.preventDefault();
        }
    });
    //阻止默认行为，stopPropagation(); -- 阻止元素冒泡事件
    $("#coordinate_file").click(function(e){
        /* js与Django交互的条件：
        1、views.py中返回的函数中的值要用 json.dumps()处理
        2、在网页上要加一个 safe 过滤器
         */
        if (!init){
            alert("请先上传.mat数据文件!");
            e.preventDefault();
        }
    });
    $("#systemGuide").click(function(e){
        e.stopPropagation();
        $(window).attr('location', '{% url 'guide' %}');
    });

    var select_start = {{ fc_info.start | default:"null"|safe }};
    var select_end = {{ fc_info.end | default:"null"|safe }};
    function select_time() {
        let threshold = $("#h2_threshold").val();
        var reg = /^0(\.[0-9]*)?$/;   // 匹配 [0,1) 的小数，包括 "0."
        if (!reg.test(threshold)){
            $("#select_confirm").css("color","deeppink").text("阈值输入有误");
        } else{
            h2_threshold = parseFloat(threshold);
            select_start = time_slider.getValue()[0];
            select_end = time_slider.getValue()[1];
            $("#h2_threshold").val(h2_threshold);
            $("#select_confirm").css("color","green").text("设置成功");
            h2_threshold_slider.setValue(h2_threshold);
            $("#h2_threshold_value").text(h2_threshold);
        }
        $("#select_confirm").css("visibility","visible");
        window.setTimeout(function() {
            $("#select_confirm").css("visibility","hidden");
        },2000)
        /*
        $("#select_confirm").fadeIn();
        $("#select_confirm").fadeOut();
        */
    }
    var mark_select = null;
    var marks_list = [['Name','Start','End','Description']];
    $("#time_marks").delegate("button.modify", "click", function () {
        let marks = [];
        // console.log($(this).parent().siblings());
        marks.push($(this).parent().siblings()[0].innerText);
        marks.push($(this).parent().siblings()[1].innerText);
        marks.push($(this).parent().siblings()[2].innerText);
        marks.push($(this).parent().siblings()[3].innerText);
        $("#operate_type").text("修改");
        $("#add_name").val(marks[0]);
        $("#add_start").val(marks[1]);
        $("#add_end").val(marks[2]);
        $("#add_desc").val(marks[3]);
        mark_select = $(this).parent();
    });
    $("#time_marks").delegate("button.apply", "click", function () {
        let mark_start = parseFloat($(this).parent().siblings()[1].innerText);
        let mark_end = parseFloat($(this).parent().siblings()[2].innerText);
        mark_start = ((mark_start-fc_info.start)/fc_info.step).toFixed()*fc_info.step + fc_info.start;
        mark_end = ((mark_end-fc_info.start)/fc_info.step).toFixed()*fc_info.step + fc_info.start;
        console.log(mark_start,mark_end);
        time_slider.setValue([mark_start, mark_end]);
    });
    $("#time_marks").delegate("button.delete", "click", function () {
        $(this).parent().parent().remove();
    });
    function operateMarks() {
        if ($("#operate_type").text() == "新增"){
            addMarks($("#add_name").val(),$("#add_start").val(),$("#add_end").val(),$("#add_desc").val());
        } else{
            modifyMarks();
        }
        cancel();
    }
    function cancel() {
        $("#add_name").val("");
        $("#add_start").val("");
        $("#add_end").val("");
        $("#add_desc").val("");
    }
    function addMarks(name,start,end,desc){
        let tr = document.createElement("tr");
        let td_name = document.createElement("td");
        td_name.innerText = name;
        let td_start = document.createElement("td");
        td_start.innerText = start;
        let td_end = document.createElement("td");
        td_end.innerText = end;
        let td_desc = document.createElement("td");
        td_desc.innerText = desc;
        let td_apply = document.createElement("td");
        let apply_button = document.createElement("button");
        apply_button.innerText = "应用";
        apply_button.setAttribute("class","btn btn-warning apply");
        let modify_button = document.createElement("button");
        modify_button.innerText = "修改";
        modify_button.setAttribute("class","btn btn-warning modify");
        modify_button.setAttribute("data-toggle","modal");
        modify_button.setAttribute("data-target","#myModal");

        let delete_button = document.createElement("button");
        delete_button.innerText = "删除";
        delete_button.setAttribute("class","btn btn-warning delete");

        td_apply.appendChild(modify_button);
        td_apply.appendChild(delete_button);
        td_apply.appendChild(apply_button);
        tr.appendChild(td_name);
        tr.appendChild(td_start);
        tr.appendChild(td_end);
        tr.appendChild(td_desc);
        tr.appendChild(td_apply);
        $("#time_marks").append(tr);
        // $("#modify_button").on("onclick", modifyMarks(td_name.innerText,td_start.innerText,td_end.innerText,td_desc.innerText));
    }
    function modifyMarks() {
        mark_select.siblings()[0].innerText = $("#add_name").val();
        mark_select.siblings()[1].innerText = $("#add_start").val();
        mark_select.siblings()[2].innerText = $("#add_end").val();
        mark_select.siblings()[3].innerText = $("#add_desc").val();
    }
    function saveMarks() {
        //alert("此功能暂未实现！") [0].childNodes[1].innerText
        let all_marks = $("#time_marks").children();
        if (all_marks.length == 0){
            alert("当前没有任何标记！");
            return;
        }
        /*
        marks_list = all_marks.map(function (mark) {
            return [mark.childNodes[0].innerText,mark.childNodes[1].innerText,mark.childNodes[2].innerText,mark.childNodes[3].innerText];
        });
        */
        for (let i=0;i<all_marks.length; i++){
            marks_list.push([all_marks[i].childNodes[0].innerText,all_marks[i].childNodes[1].innerText,all_marks[i].childNodes[2].innerText,all_marks[i].childNodes[3].innerText])
        }
        // console.log(marks_list);
        exportToCsv('time_marks.csv', marks_list);
    }
    function readToArray(data) {
        data = data[0];
        console.log(data);
        for (let i=1; i<data.length;i++){
            console.log(data[i]);
            addMarks(data[i][0],data[i][1],data[i][2],data[i][3]);
        }
    }
    function getH2() {
        if(!fc_info){
            alert("请先上传.mat数据文件!");
            return;
        }
        var s1 = parseInt($("#s1").val());
        var s2 = parseInt($("#s2").val());
        if (isNaN(s1)||isNaN(s2)||s1<0||s2<0){
            //alert(s1+"\n"+s2);
            alert("请正确输入两电极信号（格式需为非负整数）！");
            return;
        }
        var elen = fc_info["electrode_names"].length;
        if(s1>=elen || s2>=elen){
            alert("输入信号应小于"+elen+" !");
            return;
        }
        $.post('{% url 'getH2' %}',{"s1":s1,"s2":s2,"select_start":select_start,"select_end":select_end,"h2_threshold":h2_threshold},function(result, statue){
                if(result["result"] === true){
                    //h2_max, lag_max, nw_direction, (sp - sn) / (sp + sn)
                    var s1_s2 = result["s1_s2"];
                    var signal = [fc_info["electrode_names"][s1],fc_info["electrode_names"][s2]];
                    var lens = parseInt((select_end - select_start)/fc_info.step + 1);
                    //var times = d3.range(fc_info["start"],fc_info["start"]+lens);
                    var data = [];
                    for(i=0;i<lens;i++){
                        data.push({"time":select_start + i * fc_info.step,"h2":s1_s2[0][i]})
                    }
                    linechart(data,signal,lens,s1_s2[2],s1_s2[3],twoElectCO(signal,one_elect_co));
                }else {
                    alert("Failed!\n message:"+result["msg"]);
                }
        });
    }
    function fcAnalyse(){
        if (!init){
            alert("请先上传.mat数据文件!");
            return;
        }
        var ez = $("#EZ").val();
        var pz = $("#PZ").val();
        var niz = $("#NIZ").val();
        if (!(ez || pz || niz)){
            alert("您还未输入电极！(EZ、PZ、NIZ不一定要全部输入）\n请用数字表示，格式应如：0-2,4");
            return;
        }
        var fc_result = document.getElementById("fc_result");
        fc_result.style.display = "none";
        // alert(ez+"\n"+pz+"\n"+niz)
        $.post('{% url 'fcAnalyse' %}',{"ez":ez,"pz":pz,"niz":niz,"select_start":select_start,"select_end":select_end,"h2_threshold":h2_threshold},function(result, statue){
                if(result["result"] === true){
                    //h2_max, lag_max, nw_direction, (sp - sn) / (sp + sn)
                    var zones = result["zones"];
                    //alert(zones);
                    fc_result.style.display = "inline";
                    violinBwt();
                }else {
                    alert(result["msg"])
                }
        });
    }
    function showCoordinate(files) {
        //console.log(files);
        if (files[0]) {
            var reader = new FileReader();
            reader.readAsText(files[0]);
            /*
            reader.onload = function () {
                globaldata = this.result;
            }
            reader.onloadend = function (evt) {
                if(evt.target.readyState == FileReader.DONE){
                    globaldata.push(csv2array(reader.result.toString()));
                }
            };
            */
            let electrode_names = fc_info['electrode_names'];
            reader.onload = function (f) {
                //var result = document.getElementById("result");
                //显示文件
                one_elect.clear();
                for(var i=0;i<electrode_names.length;i++){
                    var two_e = electrode_names[i].split("-");
                    one_elect.add(two_e[0]);
                    one_elect.add(two_e[1]);
                }
                var co_data={"ez":[],"pz":[],"niz":[]};
                var relArr = this.result.split("\r\n");
                //var regp = new RegExp(".*,\".*,.*\"$");
                var regp = /[^\w\s,.-]/;
                if (!$.isEmptyObject(relArr) && relArr.length > 1) {
                    for (var cokey in one_elect_co){
                        //delete one_elect_co.cokey; 清空字典，只能使用下面的方法
                        delete one_elect_co[cokey];
                    }
                    var title_key = relArr[0].split(",");
                    for (var key = 1, len = relArr.length; key < len; key++) {
                        var values = relArr[key];
                        if (regp.test(values)) {
                            alert("文件内容中含有非法符号，请修改后再上传！含有非法符号的内容为：" + values);
                            return;
                        }
                        if (!$.isEmptyObject(values)) {
                            var obj = [];
                            var objArr = values.split(",");
                            for (var j=1;j<objArr.length;j++){
                                obj.push(objArr[j].replace(/\s/ig,'')); //过滤空白字符
                            }
                            if (objArr[0] === "ez"){
                                co_data.ez.push(obj);
                            } else if (objArr[0] === "pz"){
                                co_data.pz.push(obj);
                            }else if (objArr[0] === "niz"){
                                co_data.niz.push(obj);
                            }

                            if (isInSet(obj[3],one_elect)){
                                one_elect_co[obj[3]] = strArr2floatArr(obj.slice(0,-1));
                            }
                        }
                    }
                }
                $("#codination").remove();
                var newM = $("<div id='codination' style='width: 85%;height:500px;' align='center'></div>");
                newM.appendTo($("#electrodes"));
                scatter3D(co_data,'codination');
                /*
                var s1 = $("#s1").val();
                var s2 = $("#s2").val();
                if (typeof(s1)==="number"&&typeof(s2)==="number"){
                }
                */
                ez_p.length = 0;
                pz_p.length = 0;
                niz_p.length = 0;
                //console.log(co_data)
                for(var ii=0;ii<electrode_names.length;ii++){
                    var one_e = electrode_names[ii].split("-")[0];
                    //console.log(one_e)
                    var flag = true;
                    for (var jj=0;jj<co_data["ez"].length;jj++){
                        if (co_data["ez"][jj][3].includes(one_e)){
                            ez_p.push(ii);
                            flag = false;
                            break;
                        }
                    }
                    if (flag){
                        for (var jj=0;jj<co_data["pz"].length;jj++){
                            if (co_data["pz"][jj][3].includes(one_e)){
                                pz_p.push(ii);
                                flag = false;
                                break;
                            }
                        }
                    }
                    if (flag){
                        for (var jj=0;jj<co_data["niz"].length;jj++){
                            if (co_data["niz"][jj][3].includes(one_e)){
                                niz_p.push(ii);
                                //flag = false;
                                break;
                            }
                        }
                    }
                }
                //console.log(ez_p,pz_p,niz_p)
            };
        }
    }
    function assignZone() {
        if (one_elect.size === 0){
            alert("您未上传空间坐标文件,\n无法默认取值！");
            return;
        }
        if (ez_p.length+pz_p.length+niz_p.length === 0){
            alert("您上传的空间坐标文件与基本信息中的电极不符,\n无法默认取值！");
            return;
        }
        var ez_s="";
        var pz_s="";
        var niz_s="";
        for (i of ez_p){
            ez_s += ", "+i;
        }
        for (i of pz_p){
            pz_s += ", "+i;
        }
        for (i of niz_p){
            niz_s += ", "+i;
        }
        if (ez_s.length){
            $("#EZ").val(ez_s.slice(1))
        }
        if (pz_s.length){
            $("#PZ").val(pz_s.slice(1))
        }
        if (niz_s.length){
            $("#NIZ").val(niz_s.slice(1))
        }
    }
    function isInSet(item,set) {
        for (var si of set){
            if (item === si){
                return true;
            }
        }
        return false;
    }
    function strArr2floatArr(strArr) {
        var floatArr = [];
        for (var sai of strArr){
            floatArr.push(parseFloat(sai));
        }
        return floatArr;
    }
    function twoElectCO(signal,co) {
        /*
         返回电极对的中心坐标
         signal的格式例如： ['C4-C5', 'C6-C7']
          */
        var s1 = signal[0].split('-');
        var s2 = signal[1].split('-');
        return [centerPoint(co[s1[0]],co[s1[1]]),centerPoint(co[s2[0]],co[s2[1]])]
    }
    function centerPoint(co1,co2) {
        if (!(co1&&co2)){
            return null;
        }
        return [(co1[0]+co2[0])/2,(co1[1]+co2[1])/2,(co1[2]+co2[2])/2]
    }

    function outAnalyse(e, type) {
        if(!fc_info){
            alert("请先上传.mat数据文件!");
            return;
        }
        $.post('{% url 'outAnalyse' %}',{"select_start":select_start,"select_end":select_end, "h2_threshold":h2_threshold},function(result, statue){
            if(result["result"] === true) {
                let out_links = result["out_links"];
                let in_links = result["in_links"];
                $("#out_result").css("display","block");
                $("#out_links").text(out_links.map(function (d) { return " ["+d+"] "}));
                $("#in_links").text(in_links.map(function (d) { return " ["+d+"] "}));
                let step = fc_info.step;
                $(e).siblings().removeClass().addClass("btn btn-default");
                $(e).removeClass().addClass("btn btn-success");
                // console.log(out_in_links, links);
                let electrode_names = fc_info.electrode_names;
                let stream_data = [];
                let heap_data = [];
                let time = [];
                let len_t = out_links.length;
                let len_e = out_links[0].length;
                let min = 0;
                let max = 0;
                let value = 0;
                for (let i = 0; i < len_t; i++) {  // i 是时间
                    let t = select_start + i * step;
                    time.push(t);
                    for (let j = 0; j < len_e; j++) {  // j 是 电极
                        if (type === 'OUT') {
                            value = out_links[i][j];
                        }
                        else if (type === 'IN') {
                            value = in_links[i][j];
                        }
                        else if (type === 'OUT/IN') {
                            value = parseFloat(((out_links[i][j] + 1) / (in_links[i][j] + 1)).toFixed(4));
                        }
                        else if (type === 'OUT-IN') {
                            value = out_links[i][j] - in_links[i][j];
                        }
                        stream_data.push([t, value, electrode_names[j]]);
                        heap_data.push([i, len_e - j - 1, value]);
                        if (value > max) {
                            max = value;
                        } else if (value < min) {
                            min = value;
                        }
                    }
                }
                // console.log(min, max);
                if (type === 'OUT-IN') {
                    for (let i = 0; i < stream_data.length; i++) {
                        stream_data[i][1] -= min;
                    }
                }
                // console.log(stream_data);
                $("#out_chart").css("display","block");
                stream_out_in(stream_data, type, electrode_names, [select_start, time[len_t - 1]], step);
                heat_out_in(heap_data, min, max, electrode_names.concat().reverse(), time, type);
            } else{
                alert("Failed!\n message:"+result["msg"]);
            }
        });
    }

    function exportToCsv(filename, rows) {
        var processRow = function (row) {
            var finalVal = '';
            for (var j = 0; j < row.length; j++) {
                var innerValue = row[j] === null ? '' : row[j].toString();
                if (row[j] instanceof Date) {
                    innerValue = row[j].toLocaleString();
                }
                var result = innerValue.replace(/"/g, '""');
                if (result.search(/("|,|\n)/g) >= 0)
                    result = '"' + result + '"';
                if (j > 0)
                    finalVal += ',';
                finalVal += result;
            }
            return finalVal + '\n';
        };

        var csvFile = '';
        for (var i = 0; i < rows.length; i++) {
            csvFile += processRow(rows[i]);
        }

        var blob = new Blob([csvFile], { type: 'text/csv;charset=UTF-8;' });
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        } else {
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    }
    function readFromCsv(file_e, callback) {
        var data = [];
        // var file = document.getElementById(file_name).files[0];
        var file = file_e.files[0];
        var reader = new FileReader();
        reader.readAsText(file,'UTF-8');
        //读取完文件之后，执行下面这个回调函数：
        reader.onload = function (evt) {
            data.push(csv2array(reader.result.toString()));
            callback && callback(data);
        }
    }
    function csv2array(data, delimeter) {
        // Retrieve the delimeter
        if (delimeter == undefined)
            delimeter = ',';
        if (delimeter && delimeter.length > 1)
            delimeter = ',';

        // initialize variables
        var newline = '\n';
        var eof = '';
        var i = 0;
        var c = data.charAt(i);
        var row = 0;
        var col = 0;
        var array = new Array();

        while (c != eof) {
            // skip whitespaces
            while (c == ' ' || c == '\t' || c == '\r') {
                c = data.charAt(++i); // read next char
            }

            // get value
            var value = "";
            if (c == '\"') {
                // value enclosed by double-quotes
                c = data.charAt(++i);

                do {
                    if (c != '\"') {
                        // read a regular character and go to the next character
                        value += c;
                        c = data.charAt(++i);
                    }

                    if (c == '\"') {
                        // check for escaped double-quote
                        var cnext = data.charAt(i+1);
                        if (cnext == '\"') {
                            // this is an escaped double-quote.
                            // Add a double-quote to the value, and move two characters ahead.
                            value += '\"';
                            i += 2;
                            c = data.charAt(i);
                        }
                    }
                }
                while (c != eof && c != '\"');

                if (c == eof) {
                    throw "Unexpected end of data, double-quote expected";
                }

                c = data.charAt(++i);
            }
            else {
                // value without quotes
                while (c != eof && c != delimeter && c!= newline) {
                    value += c;
                    c = data.charAt(++i);
                }
            }

            // add the value to the array
            if (array.length <= row)
                array.push(new Array());
            array[row].push(value);

            // skip whitespaces
            while (c == ' ' || c == '\t' || c == '\r') {
                c = data.charAt(++i);
            }

            // go to the next row or column
            if (c == delimeter) {
                // to the next column
                col++;
            }
            else if (c == newline) {
                // to the next row
                col = 0;
                row++;
            }
            else if (c != eof) {
                // unexpected character
               throw "Delimiter expected after character " + i;
            }

            // go to the next character
            c = data.charAt(++i);
        }

        return array;
    }
</script>
</html>