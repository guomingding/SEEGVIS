<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SEEGVIS</title>
    <link rel="icon" href="/static/data/eeg3.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.3.0/echarts.min.js"></script>
    <script src="/static/js/echarts-gl.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/css/bootstrap-slider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/bootstrap-slider.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.11/css/bootstrap-select.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>

    <script src="/static/js/d3.v4.js"></script>
    <script src="/static/js/d3-scale-chromatic.v1.min.js"></script>

    <script src="/static/js/seegvis.js"></script>
    <script src="/static/js/visChart.js"></script>
    <link rel="stylesheet" href="/static/css/seegvis.css">
</head>
<body>
<div class="panel-group" id="accordion">
    <div class="panel panel-default">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
            <h4 class="panel-title">
                <label>基本信息</label>
                <span class="badge" id="systemGuide" style="float: right;font-size:18px; margin-right: 50px;cursor: pointer;" title="查看使用说明">系统指南</span>
            </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in">
            <div class="panel-body">
                <form method="post" action="/" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% if not fc_info %}
                        请上传mat格式文件：<input type="file" accept=".mat" name="up_file" class="file_mat button"/>
                        <input type="submit" value="提交" class="submit_mat button"/><br>
                    {% else %}
                        更改数据文件：<input type="file" accept=".mat" name="up_file" class="file_mat button"/>
                        <input type="submit" value="更改" class="submit_mat button"/><br>
                    {% endif %}
                </form>
                {% if fc_info %}
                <div style="font-size: 26px;font-weight: bold;text-align: center;margin-bottom: 15px;margin-top: 10px;">
                    当前上传的数据文件为：<font color="red">{{ file_name }}</font>
                </div>
                <div style="display: inline-block;width: 62%;">
                    <table align="center" class="table tab1 table-bordered" style="text-align: center;max-width: 95%">
                        <tbody>
                        {% for key,value in fc_info.items %}
                            <tr class="active">
                                <td>{{ key }}</td>
                                {% if key == 'electrode_names' %}
                                    <td>
                                    {% for item in value %}
                                        {{ forloop.counter0 }}:&nbsp;{{ item }};&nbsp;
                                    {% endfor %}
                                    </td>
                                {% else %}
                                    <td>{{ value }}</td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="display: inline-block; width: 35%; vertical-align: top;">
                    <h3 style="margin-top: 6px;">控制面板&nbsp;(DashBoard)</h3>
                    <div style="margin-top: 30px;">
                        <b>筛选通道：</b>
                        <select id="select_channels" class="selectpicker" multiple data-live-search="true" data-actions-box="true">
                            {% for electrode in fc_info.electrode_names %}
                                <option>{{ electrode }}</option>
                            {% endfor %}
                        </select>
                        &nbsp;&nbsp;&nbsp;当前共选择&nbsp;<span id="electrodes_num" style="color:red;"></span>&nbsp;个通道
                    </div>
                    <div style="margin-top: 35px;">
                        <b>筛选时间：{{ fc_info.start }}</b>&nbsp;&nbsp;&nbsp;&nbsp;
                        <input id="time_slider" type="text"/><b>&nbsp;&nbsp;&nbsp;&nbsp;
                        {{ fc_info.end }}</b>
                    </div>
                    <div style="margin-top: 30px;">
                        <b>设置阈值：</b>
                        <input id="h2_threshold" type="text" value="0" maxlength="12" onkeyup="value=value.replace(/[^.\d]/g,'')">
                    </div>
                    <div style="margin-top: 30px;">
                        <b>筛选子波：</b>
                        <select id="select_wave" class="selectpicker">
                            <option>Any Wave</option>
                            <option>Delta</option>
                            <option>Theta</option>
                            <option>Alpha</option>
                            <option>Beta</option>
                            <option>Gamma</option>
                            <option>Gamma2</option>
                            <option>Ripple</option>
                            <option>Fast Ripple</option>
                        </select>
                        &nbsp;&nbsp;<span style="color:red;">筛选子波功能暂未实现！</span>
                    </div>
                    <div style="margin-top:20px;">
                    &nbsp;&nbsp;<button class="btn btn-default" onclick="select_confirm()">确认选择</button>&nbsp;
                        <button class="btn btn-warning" onclick="select_reset()">恢复默认</button>&nbsp;&nbsp;
                        <div id="select_confirm" style="display:inline-block;font-size: larger; text-align: left;"></div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center">
                    <div>
                        <label>
                            <span class="btn btn-primary"> 
                                读取标记文件<input type="file" accept=".txt,.csv" style="display: none;" multiple onchange="readFromCsv(this,readToArray)">
                            </span>
                        </label>
                        <button class="btn btn-primary" onclick="saveMarks()">保存时间标记</button>
                        <button class="btn btn-primary" data-toggle="modal" data-target="#myModal"
                                onclick=$("#operate_type").text("新增")>新增时间标记</button>
                        <button class="btn btn-primary" onclick=$("#time_marks").empty()>清空所有标记</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <table class="table table-bordered" align="center" style="width: 72%">
                            <thead>
                                <tr>
                                    <th width="145px;">标记名</th>
                                    <th width="135px;">起始时间</th>
                                    <th width="135px;">终止时间</th>
                                    <th style="min-width: 160px;">描述</th>
                                    <th width="250px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="time_marks">
                            </tbody>
                        </table>
                    </div>
                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="cancel()">
                                        &times;
                                    </button>
                                    <h4 class="modal-title" id="myModalLabel">
                                        <span id="operate_type"></span>时间标记
                                    </h4>
                                </div>
                                <div class="modal-body">
                                    <div style="display: inline-block; width: 34%;">
                                        <div class="input-group">
                                            <span class="input-group-addon">标记名</span>
                                            <input id="add_name" type="text" class="form-control">
                                        </div>
                                    </div>
                                    <div style="display: inline-block; width: 32%;">
                                        <div class="input-group">
                                            <span class="input-group-addon">起始时间</span>
                                            <input id="add_start" type="text" class="form-control" onkeyup="value=value.replace(/[^.\d]/g,'')">
                                        </div>
                                    </div>
                                    <div style="display: inline-block; width: 32%;">
                                        <div class="input-group">
                                            <span class="input-group-addon">终止时间</span>
                                            <input id="add_end" type="text" class="form-control" onkeyup="value=value.replace(/[^.\d]/g,'')">
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-addon">描述</span>
                                        <input id="add_desc" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="cancel()">取消</button>
                                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="operateMarks()">
                                        确定
                                    </button>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal -->
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="panel panel-success">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
            <h4 class="panel-title">
                <label>空间坐标</label>
            </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse">
            <div class="panel-body" id="electrodes">
                请上传对应电极点的空间坐标：<input type="file" accept=".txt,.csv" id="coordinate_file" class="button"
                                     onchange="showCoordinate(this.files)"/>
            </div>
        </div>
    </div>
    <div class="panel panel-info">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
            <h4 class="panel-title">
                <label>折线图</label>
            </h4>
        </div>
        <div id="collapseThree" class="panel-collapse collapse">
            <div class="panel-body">
                <table>
                    <tbody>
                    <tr>
                        <td style="padding:15px 10px">
                            <div class="input-group">
                                <span class="input-group-addon">信号1（S1）：</span>
                                <input class="form-control" type="text" id="s1">
                            </div>
                        </td>
                        <td style="padding:15px 10px">
                            <div class="input-group">
                                <span class="input-group-addon">信号2（S2）：</span>
                                <input class="form-control" type="text" id="s2">
                            </div>
                        </td>
                        <td>
                            <label class="btn btn-success" onclick="getH2()">提交</label>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <!-- Create a div where the graph will take place -->
                <div id="my_dataviz"></div>
            </div>
        </div>
    </div>
    <div class="panel panel-warning">
        <div class="panel-heading"  data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
            <h4 class="panel-title">
                <label>小提琴图</label>
            </h4>
        </div>
        <div id="collapseFour" class="panel-collapse collapse">
            <div class="panel-body">
                <div id="analyse">
                    <table>
                        <tbody>
                        <tr>
                            <td style="margin-left: 10px">
                                <label class="btn btn-primary" onclick="assignZone()">参考空间坐标</label>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">EZ: </span>
                                    <input class="form-control" type="text" id="EZ">
                                </div>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">PZ: </span>
                                    <input class="form-control" type="text" id="PZ">
                                </div>
                            </td>
                            <td style="padding:15px 10px">
                                <div class="input-group">
                                    <span class="input-group-addon">NIZ: </span>
                                    <input class="form-control" type="text" id="NIZ">
                                </div>
                            </td>
                            <td>
                                <label class="btn btn-success" onclick="fcAnalyse()">FC分析</label>
                            </td>
                            <td style="padding-left: 10px;">
                                <label class="btn btn-success" onclick="violin_play()">播放</label>
                                <label class="btn btn-success" onclick="violin_pause(this)" id="play_pause">暂停</label>
                            </td>
                            <td >
                                <a id="fc_result" style="margin-left: 15px;display: none;" href="/static/data/fc_result.csv">下载FC计算结果</a>
                            </td>
                             <td >
                                <a id="fc_result_s" style="margin-left: 15px;display: none;cursor: pointer;" onclick="downloadFCStatistic()">下载FC统计结果</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <!-- Create a div where the graph will take place -->
                    <div id="violinTimeDiv" style="margin-left: 360px;display: none;">
                        <label id="lastTime" onclick="last_time()" class="btn-sm btn-default ctlTime">上一时刻</label>
                        &nbsp;当前时间为：<span id="violinTimeSpan" style="color:red;"></span>&nbsp;
                        <label id="nextTime" onclick="fc_play()" class="btn-sm btn-default ctlTime">下一时刻</label>
                    </div>
                    <div id="violinBwt">
                        <div id="violinLeft" style="width:1000px;float:left; text-align: center;margin-left: 10px;"></div>
                        <div id="violinRight" style="width:300px;float:left; text-align: center;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-danger">
        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseFive">
            <h4 class="panel-title">
                <label>OUT&nbsp;分析</label>
            </h4>
        </div>
        <div id="collapseFive" class="panel-collapse collapse">
            <div id="out_result" style="margin-left: 12px; display: none;">
                OUT LINKS:<br>
                <span id="out_links"></span><br>
                IN LINKS:<br>
                <span id="in_links"></span><br>
                <a href="/static/data/out_result.xls">点击下载OUT分析结果</a>
            </div>
            <div class="panel-body">
                <table align="center">
                    <td style="width: 168px;">
                        <b style="font-size: larger;">当前h2阈值为：<span id="h2_threshold_value" style="color: red">0</span></b>
                    </td>
                    <td style="padding-right: 20px;">
                        <input id="h2_threshold2" class="form-control" type="text"/>
                    </td>
                    <td>
                        <button class="btn btn-default" onclick="outAnalyse(this,'OUT')">OUT</button>
                        <button class="btn btn-default" onclick="outAnalyse(this,'OUT/IN')">OUT / IN</button>
                        <button class="btn btn-default" onclick="outAnalyse(this,'OUT-IN')">OUT - IN</button>
                        <button class="btn btn-default" onclick="outAnalyse(this,'IN')">IN</button>
                    </td>
                </table>
                <div id="out_chart" style="display: none; margin-top: 15px;">
                    <!--
                    <div id="out_in_river" style="display: inline-block;height: 500px; width: 58%; min-width: 800px"></div>
                    <div id="out_in_heat" style="display: inline-block;height: 500px; width: 40%; min-width: 600px"></div>
                    -->
                    <div id="out_in_river" style="height: 500px; width: 58%; float: left"></div>
                    <div id="out_in_heat" style="height: 500px; width: 42%; float: left"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    var fc_info = {{ fc_info | default:"null"|safe }}; // 注意： 冒号后面不能有空格！ 引号中可以是对象，如 :"{xk:12}"
    var init = {{ file_name|default:"null"|safe }};
    var msg = {{ msg|default:"null"|safe }};
    var electrodes_len = 0;  // 可以用来判断是否传入文件
    if(msg){
        alert(msg);
    }
    var one_elect = new Set(); //电极点名字
    var one_elect_co = {};
    var ez_p=[];
    var pz_p=[];
    var niz_p=[];

    var div1 = d3.select("body").append("div")  // 折线图的tooltip
    .attr("class", "tooltip1")  // bootstrap 有自己的tootlip，所以命名需为tooltip1，防止冲突
    .style("opacity", 0).style("width","80px").style("height","51px");

    var div2 = d3.select("body").append("div")  // 小提琴图的面积tooltip
    .attr("class", "tooltip1").style("text-align","left")
    .style("opacity", 0).style("width","96px").style("height","83px"); // 68px

    var div3 = d3.select("body").append("div")  // 小提琴图的点tooltip
    .attr("class", "tooltip1")  //area
    .style("opacity", 0).style("width","60px").style("height","20px");

    var h2_threshold = 0;
    var h2_threshold_slider = new Slider("#h2_threshold2", {
        min: 0,
        max: 1,
        step: 0.001,
        value: 0
    });
    h2_threshold_slider.on("change", function (val) {  // 不能用slide，因为slide 是指拖动，不是改变
        $("#h2_threshold_value").text(val.newValue);
        $("#h2_threshold").val(val.newValue);
        h2_threshold = val.newValue;
    });

    var time_slider = null;
    var select_channels = $('#select_channels');
    var select_ei = [];  // 选择电极（通道）的下标数组
    var select_wave = $("#select_wave");
    if (init){
        time_slider = new Slider('#time_slider', {
            min: fc_info.start,
            max: fc_info.end,
            step: fc_info.step,
            value: [fc_info.start, fc_info.end],
            // tooltip: 'always'
        });
        /*
        slider.on("slideStart", function(o){
            console.log("OO",o);
            //console.log("NN",n);
        });
        */
        select_wave.selectpicker({});
        select_wave.selectpicker('render');

        select_channels.selectpicker({});
        select_channels.selectpicker('selectAll');
        select_channels.selectpicker('render');
        electrodes_len = select_channels.val().length;
        $("#electrodes_num").text(electrodes_len);
        select_channels.on("change",function () {
            $("#electrodes_num").text(select_channels.val().length);
        });
        for (let i =0; i < electrodes_len; i++){
            select_ei.push(i);
        }
    }

    $(".submit_mat").click(function(e){
        //alert($(".file_mat").val());
        if (!$(".file_mat").val()){
            alert("您还未选择.mat数据文件!");
            e.preventDefault();
        }
    });
    //阻止默认行为，stopPropagation(); -- 阻止元素冒泡事件
    $("#coordinate_file").click(function(e){
        /* js与Django交互的条件：
        1、views.py中返回的函数中的值要用 json.dumps()处理
        2、在网页上要加一个 safe 过滤器
         */
        if (!init){
            alert("请先上传.mat数据文件!");
            e.preventDefault();
        }
    });
    $("#systemGuide").click(function(e){
        e.stopPropagation();
        $(window).attr('location', '{% url 'guide' %}');
    });

    var select_start = {{ fc_info.start | default:"null"|safe }};
    var select_end = {{ fc_info.end | default:"null"|safe }};

    function select_confirm() {
        let threshold = $("#h2_threshold").val();
        var reg = /^0(\.[0-9]*)?$/;   // 匹配 [0,1) 的小数，包括 "0."
        if (!reg.test(threshold)){
            $("#select_confirm").css("color","deeppink").text("阈值输入有误");
        } else{
            h2_threshold = parseFloat(threshold);
            select_start = time_slider.getValue()[0];
            select_end = time_slider.getValue()[1];
            let select_electrodes = select_channels.val();
            select_ei = [];
            for (let i =0; i < select_channels.val().length; i++){
                select_ei.push(fc_info.electrode_names.indexOf(select_electrodes[i]));
            }

            $("#h2_threshold").val(h2_threshold);
            h2_threshold_slider.setValue(h2_threshold);
            $("#h2_threshold_value").text(h2_threshold);

            $("#select_confirm").css("color","green").text("设置成功");
        }
        $("#select_confirm").css("visibility","visible");
        window.setTimeout(function() {
            $("#select_confirm").css("visibility","hidden");
        },2000)
        /*
        $("#select_confirm").fadeIn();
        $("#select_confirm").fadeOut();
        */
    }
    function select_reset() {
        select_start = {{ fc_info.start | default:"null"|safe }};
        select_end = {{ fc_info.end | default:"null"|safe }};
        select_ei = [];
        for (let i =0; i < electrodes_len; i++){
            select_ei.push(i);
        }
        h2_threshold = 0;

        time_slider.setValue([select_start, select_end]);
        select_channels.selectpicker('selectAll');
        $("#electrodes_num").text(select_channels.val().length);
        $("#h2_threshold").val(0);

        $("#select_confirm").css("color","green").css("visibility","visible").text("恢复成功");
        window.setTimeout(function() {
            $("#select_confirm").css("visibility","hidden");
        },2000)
    }
    var mark_select = null;
    // var marks_list = [['Name','Start','End','Description']];
    $("#time_marks").delegate("button.modify", "click", function () {
        let marks = [];
        // console.log($(this).parent().siblings());
        marks.push($(this).parent().siblings()[0].innerText);
        marks.push($(this).parent().siblings()[1].innerText);
        marks.push($(this).parent().siblings()[2].innerText);
        marks.push($(this).parent().siblings()[3].innerText);
        $("#operate_type").text("修改");
        $("#add_name").val(marks[0]);
        $("#add_start").val(marks[1]);
        $("#add_end").val(marks[2]);
        $("#add_desc").val(marks[3]);
        mark_select = $(this).parent();
    });
    $("#time_marks").delegate("button.apply", "click", function () {
        let mark_start = parseFloat($(this).parent().siblings()[1].innerText);
        let mark_end = parseFloat($(this).parent().siblings()[2].innerText);
        if (isNaN(mark_start) || isNaN(mark_end)){
            alert("请将起始时间和终止时间设为数字！");
            return;
        }
        if (mark_start > mark_end) {
            alert("起始时间需小于终止时间！");
            return;
        }
        mark_start = ((mark_start-fc_info.start)/fc_info.step).toFixed()*fc_info.step + fc_info.start;
        mark_end = ((mark_end-fc_info.start)/fc_info.step).toFixed()*fc_info.step + fc_info.start;
        // console.log(mark_start,mark_end);
        time_slider.setValue([mark_start, mark_end]);
    });
    $("#time_marks").delegate("button.delete", "click", function () {
        $(this).parent().parent().remove();
    });
    // 之所以以下文件不放进单独的js文件中，是因为引用了Django模板
    function getH2() {
    if(!fc_info){
        alert("请先上传.mat数据文件!");
        return;
    }
    var s1 = parseInt($("#s1").val());
    var s2 = parseInt($("#s2").val());
    if (isNaN(s1)||isNaN(s2)||s1<0||s2<0){
        //alert(s1+"\n"+s2);
        alert("请正确输入两电极信号（格式需为非负整数）！");
        return;
    }
    var elen = fc_info["electrode_names"].length;
    if(s1>=elen || s2>=elen){
        alert("输入信号应小于"+elen+" !");
        return;
    }
    $.get('{% url 'getH2' %}',{"s1":s1,"s2":s2,"select_start":select_start,"select_end":select_end,"h2_threshold":h2_threshold},
        function(result, statue){
            if(result["result"] === true){
                //h2_max, lag_max, nw_direction, (sp - sn) / (sp + sn)
                var s1_s2 = result["s1_s2"];
                var signal = [fc_info["electrode_names"][s1],fc_info["electrode_names"][s2]];
                var lens = parseInt((select_end - select_start)/fc_info.step + 1);
                //var times = d3.range(fc_info["start"],fc_info["start"]+lens);
                var data = [];
                for(i=0;i<lens;i++){
                    data.push({"time":select_start + i * fc_info.step,"h2":s1_s2[0][0][i], "lag":s1_s2[0][1][i]})
                }
                linechart(data,signal,lens,s1_s2[0][2],s1_s2[0][3],twoElectCO(signal,one_elect_co),{
                    "median": [s1_s2[1][0],s1_s2[2][0],s1_s2[3][0]],
                    "mean": [s1_s2[1][1],s1_s2[2][1],s1_s2[3][1]],
                    "max": [s1_s2[1][2],s1_s2[2][2],s1_s2[3][2]],
                    "min": [s1_s2[1][3],s1_s2[2][3],s1_s2[3][3]]
                });
            }else {
                alert("Failed!\n message:"+result["msg"]);
            }
    });
}
var databyType={};
var ez,pz,niz;
var play_i = showTimeInterval = null;
function fcAnalyse(){
    if (!init){
        alert("请先上传.mat数据文件!");
        return;
    }
    ez = $("#EZ").val();
    pz = $("#PZ").val();
    niz = $("#NIZ").val();
    if (!(ez || pz || niz)){
        alert("您还未输入电极！(EZ、PZ、NIZ不一定要全部输入）\n请用数字表示，格式应如：0-2,4");
        return;
    }

    $(".ctlTime").css("visibility","hidden");
    $("#play_pause").text("暂停");
    if (showTimeInterval) {
        clearInterval(showTimeInterval);
    }

    var fc_result = document.getElementById("fc_result");
    fc_result.style.display = "none";
    var fc_result_s = document.getElementById("fc_result_s");
    fc_result_s.style.display = "none";
    // alert(ez+"\n"+pz+"\n"+niz)
    let violinTimeDiv = $("#violinTimeDiv");
    //violinTimeDiv.style.display = "none";
    let violinTimeSpan = $("#violinTimeSpan");

    $.post('{% url 'fcAnalyse' %}',{"ez":ez,"pz":pz,"niz":niz,"select_start":select_start,"select_end":select_end,"h2_threshold":h2_threshold},
        function(result, statue){
            if(result["result"] === true){
                //h2_max, lag_max, nw_direction, (sp - sn) / (sp + sn)
                // var zones = result["zones"];
                fc_result.style.display = "inline";
                fc_result_s.style.display = "inline";
                violinTimeDiv.css("display","inline");
                violinTimeSpan.text(select_start + " -- " + select_end);
                violinBwt();
            }else {
                alert(result["msg"])
            }
    });
}
    function outAnalyse(e, type) {
    if(!fc_info){
        alert("请先上传.mat数据文件!");
        return;
    }
    $.get('{% url 'outAnalyse' %}',{"select_start":select_start,"select_end":select_end, "h2_threshold":h2_threshold, "select_ei":JSON.stringify(select_ei)},
        function(result, statue){
            if(result["result"] === true) {
                let out_links = result["out_links"];
                let in_links = result["in_links"];
                $("#out_result").css("display","block");
                $("#out_links").text(out_links.map(function (d) { return " ["+d+"] "}));
                $("#in_links").text(in_links.map(function (d) { return " ["+d+"] "}));
                let step = fc_info.step;
                $(e).siblings().removeClass().addClass("btn btn-default");
                $(e).removeClass().addClass("btn btn-success");
                // console.log(out_in_links, links);
                let select_electrode_names = [];
                let stream_data = [];
                let heap_data = [];
                let time = [];
                let len_t = out_links.length;
                let len_e = out_links[0].length;
                let min = 0;
                let max = 0;
                let value = 0;
                for (let j = 0; j < len_e; j++) {  // 初始化所选电极通道名
                    select_electrode_names.push(fc_info.electrode_names[select_ei[j]]);
                }
                for (let i = 0; i < len_t; i++) {  // i 是时间
                    let t = select_start + i * step;
                    time.push(t);
                    for (let j = 0; j < len_e; j++) {  // j 是 电极
                        if (type === 'OUT') {
                            value = out_links[i][j];
                        }
                        else if (type === 'IN') {
                            value = in_links[i][j];
                        }
                        else if (type === 'OUT/IN') {
                            value = parseFloat(((out_links[i][j] + 1) / (in_links[i][j] + 1)).toFixed(4));
                        }
                        else if (type === 'OUT-IN') {
                            value = out_links[i][j] - in_links[i][j];
                        }
                        stream_data.push([t, value, select_electrode_names[j]]);
                        heap_data.push([i, len_e - j - 1, value]);
                        if (value > max) {
                            max = value;
                        } else if (value < min) {
                            min = value;
                        }
                    }
                }
                // console.log(min, max);
                if (type === 'OUT-IN') {
                    for (let i = 0; i < stream_data.length; i++) {
                        stream_data[i][1] -= min;
                    }
                }
                // console.log(stream_data);
                $("#out_chart").css("display","block");
                stream_out_in(stream_data,select_electrode_names, [select_start, time[len_t - 1]], step);
                heat_out_in(heap_data, min, max, select_electrode_names.concat().reverse(), time);
            } else{
                alert("Failed!\n message:"+result["msg"]);
            }
    });
}

function violin_play() {
    if (!init){
        alert("请先上传.mat数据文件!");
        return;
    }
    ez = $("#EZ").val();
    pz = $("#PZ").val();
    niz = $("#NIZ").val();
    if (!(ez || pz || niz)){
        alert("您还未输入电极！(EZ、PZ、NIZ不一定要全部输入）\n请用数字表示，格式应如：0-2,4");
        return;
    }
    $(".ctlTime").css("visibility","visible");
    $("#play_pause").text("暂停");
    /*
    for (let play_i=select_start, ti = 0;play_i<=fc_info.end;play_i+=fc_info.step, ti++){
        window.setTimeout(function() {
            console.log(play_i);
            fc_play(play_i);
        },1200*ti);
    }
    */
    play_i = select_start;
    if (showTimeInterval) {
        clearInterval(showTimeInterval);
    }
    showTimeInterval=setInterval(fc_play,1200);
}
function violin_pause(obj) {
    let type = $(obj).text();
    //console.log(type);
    if (type == "暂停"){
        clearInterval(showTimeInterval);
        $(obj).text("继续");
    }else {
        showTimeInterval=setInterval(fc_play,1200);
        $(obj).text("暂停");
    }
}
function last_time() {
    if (play_i == select_start){
        play_i = select_end - fc_info.step;

    } else if(play_i - fc_info.step == select_start){
        play_i = select_end;
    } else {
        play_i -= fc_info.step * 2;
    }
    fc_play();
}
/*
function next_time() {
    fc_play();
}
*/
function fc_play() {
    //console.log(play_i);
    var fc_result = document.getElementById("fc_result");
    fc_result.style.display = "none";
    var fc_result_s = document.getElementById("fc_result_s");
    fc_result_s.style.display = "none";
    // alert(ez+"\n"+pz+"\n"+niz)
    let violinTimeDiv = $("#violinTimeDiv");
    let violinTimeSpan = $("#violinTimeSpan");

    $.post('{% url 'fcAnalyse' %}',{"ez":ez,"pz":pz,"niz":niz,"select_start":play_i,"select_end":play_i,"h2_threshold":h2_threshold},
        function(result, statue){
            if(result["result"] === true){
                //h2_max, lag_max, nw_direction, (sp - sn) / (sp + sn)
                // var zones = result["zones"];
                violinTimeDiv.css("display","inline");
                violinTimeSpan.text(play_i);

                if (play_i == select_end){
                    play_i = select_start;
                } else{
                    play_i += fc_info.step;
                }
                fc_result.style.display = "inline";
                fc_result_s.style.display = "inline";
                violinBwt();
            }else {
                alert(result["msg"])
            }
    });
}
</script>
</html>